# Used to get the Skype premium codes from the mail

import imaplib, email, base64, sys, re, getpass
found = 0
done  = 0
codes = []
 
saveName = raw_input('Output File Name: ').strip()
email_in = raw_input('Email: ').strip()
pass_in  = getpass.getpass('Password: ').strip()
 
 
print 'Logging in...'
 
conn = imaplib.IMAP4_SSL("imap.gmail.com", 993)
conn.login(email_in, pass_in)
conn.select()
 
typ, data = conn.uid('search', None, r'(X-GM-RAW "subject:\"Skype\"")')
 
found = len(data[0].split(' '))
 
print 'Found', found, 'Codes'
 
print 'Starting the bot...'
 
def save():
	global saveName, codes
	
	with open(saveName, 'w+') as f:
		f.writelines(codes)
		
	print '---'
	print 'Saved codes to:', saveName
	print '---'
	
for num in data[0].split():
	typ, data = conn.uid('fetch', num, '(RFC822)')
	msg = email.message_from_string(data[0][1])
	
	if msg['Subject'] != 'Claim your free Skype Group video calls':
		continue
		
	for part in msg.walk():
		try:
			code = re.search('(SKYPE-\w{5}-\w{5}-\w{5}-\w{5})', base64.b64decode(part.get_payload())).group(1).strip()
			print 'Found code (' + str(done) + '/' + str(found) + '):', code
			codes.append(code + "\n")
			
			done += 1
				
			if done % 10 == 0:
				save()
		except:
			print 'Invalid code'
			
save()
 
print 'Done found:', done, 'Codes.'
